# CloudKit Shared Transcript Cache

## Overview

The CloudKit integration enables **cross-user transcript sharing**, dramatically reducing transcription time from **2-5 minutes to ~3 seconds** when a transcript has already been generated by another user.

## How It Works

### Smart Workflow

```
User requests transcript
        â†“
Check CloudKit public database
        â†“
    Found? â”€â”€â”€YESâ”€â”€â†’ Download (3 seconds) â”€â”€â†’ Done! âœ…
        â”‚
       NO
        â†“
Generate locally (2-5 minutes)
        â†“
Upload to CloudKit (help other users)
        â†“
Done! âœ…
```

### Benefits

**For Users:**
- âš¡ **95%+ time savings** when transcript exists
- ğŸ”‹ **Battery savings** (no local transcription processing)
- ğŸ’¾ **Storage savings** (no duplicate model downloads)
- ğŸ¤ **Community benefit** (your transcripts help others)

**Technical:**
- ğŸ”’ **Privacy-first** (public database, anonymous)
- ğŸ“¡ **Offline support** (falls back to local)
- ğŸš€ **Non-blocking** (upload in background)
- ğŸ“Š **Statistics tracking** (downloads/uploads/time saved)

---

## Architecture

### Components

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  TranscriptManager                       â”‚
â”‚  - Orchestrates transcript generation                   â”‚
â”‚  - Checks CloudKit first                                â”‚
â”‚  - Falls back to local generation                       â”‚
â”‚  - Uploads after successful generation                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TranscriptServiceâ”‚   â”‚ CloudKitTranscriptServiceâ”‚
â”‚ - Local generationâ”‚   â”‚ - Query public database â”‚
â”‚ - Apple Speech   â”‚   â”‚ - Download transcripts  â”‚
â”‚ - SRT creation   â”‚   â”‚ - Upload transcripts    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ - Statistics tracking   â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚ CloudKit Public DB â”‚
                       â”‚ (Shared Transcripts)â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Usage Guide

### 1. Enable CloudKit Sync

```swift
// In Settings or onboarding
TranscriptManager.shared.setCloudKitEnabled(true)
```

**User must have:**
- iCloud account signed in
- Internet connection (for initial check/download)

### 2. Queue Transcript with CloudKit Support

```swift
// NEW: Pass audioURL for CloudKit lookup
TranscriptManager.shared.queueTranscript(
    episodeTitle: episode.title,
    podcastTitle: podcast.title,
    audioPath: localAudioPath,
    audioURL: episode.audioURL,  // âœ… Required for CloudKit
    language: podcast.language
)
```

**Important:** `audioURL` serves as the unique identifier for CloudKit lookups. Episodes with the same `audioURL` will share transcripts across users.

### 3. Monitor Progress with All States

```swift
TranscriptManager.shared.$activeJobs
    .sink { jobs in
        if let job = jobs[episodeKey] {
            switch job.status {
            // CloudKit states
            case .checkingCloudKit:
                print("ğŸ” Searching CloudKit...")

            case .downloadingFromCloudKit(let progress):
                print("â¬‡ï¸ Downloading: \(Int(progress * 100))%")

            // Local generation states
            case .downloadingModel(let progress):
                print("ğŸ“¦ Downloading model: \(Int(progress * 100))%")

            case .transcribing(let progress):
                print("ğŸ™ï¸ Transcribing: \(Int(progress * 100))%")

            case .uploadingToCloudKit(let progress):
                print("â¬†ï¸ Uploading: \(Int(progress * 100))%")

            case .completed:
                switch job.source {
                case .cloudKitDownload:
                    print("âœ… Downloaded from CloudKit!")
                case .localGeneration:
                    print("âœ… Generated locally and uploaded!")
                case .manual:
                    print("âœ… Manual import")
                }

            case .failed(let error):
                print("âŒ Failed: \(error)")

            case .queued:
                print("â³ Queued...")
            }
        }
    }
```

### 4. View Statistics

```swift
Task {
    let stats = await TranscriptManager.shared.getCloudKitStats()

    print("Downloads: \(stats.totalDownloaded)")
    print("Uploads: \(stats.totalUploaded)")
    print("Time saved: \(stats.formattedTimeSaved)")
    print("Data transferred:")
    print("  Downloaded: \(stats.formattedDataDownloaded)")
    print("  Uploaded: \(stats.formattedDataUploaded)")
}

// Example output:
// Downloads: 15
// Uploads: 3
// Time saved: 30 minutes
// Data downloaded: 2.3 MB
// Data uploaded: 850 KB
```

---

## CloudKit Schema

### Record Type: `SharedTranscript`

| Field | Type | Indexed | Description |
|-------|------|---------|-------------|
| episodeAudioURL | String | âœ… | Unique episode identifier (primary key) |
| episodeTitle | String | âŒ | Display name for UI |
| podcastTitle | String | âœ… | For batch queries by podcast |
| language | String | âŒ | Transcript language ("en", "zh-tw", etc.) |
| transcriptContent | String | âŒ | Full SRT file content |
| audioDuration | Double | âŒ | Episode duration for validation |
| createdDate | Date | âŒ | When transcript was generated |
| creatorID | String | âŒ | Always "anonymous" (privacy) |
| downloadCount | Int | âŒ | Popularity metric |
| transcriptionVersion | String | âŒ | For future compatibility |

### Indexes

**Required for performance:**
- `episodeAudioURL` (fast episode lookups)
- `podcastTitle` (batch queries)

### Setting Up CloudKit

1. **Xcode â†’ Signing & Capabilities**
   - Add "iCloud" capability
   - Enable "CloudKit"
   - Use container: `iCloud.com.podcastanalyzer`

2. **CloudKit Dashboard** (https://icloud.developer.apple.com)
   - Select your container
   - Go to "Schema" â†’ "Record Types"
   - Create `SharedTranscript` record type
   - Add fields as specified above
   - Add indexes on `episodeAudioURL` and `podcastTitle`

3. **Permissions**
   - Set to "Public" database
   - Enable "Read" for everyone
   - Enable "Write" for everyone (for uploads)

---

## Advanced Features

### 1. Batch Download for Podcast Series

```swift
let service = CloudKitTranscriptService()

// Get all transcript URLs for a podcast
let episodes = podcast.episodes.map { $0.audioURL }

// Download all available transcripts
let transcripts = try await service.batchDownload(episodeURLs: episodes)

// Process results
for (url, content) in transcripts {
    print("Episode \(url): \(content.count) bytes")
}
```

### 2. Find All Transcripts for a Podcast

```swift
let service = CloudKitTranscriptService()

let transcripts = try await service.findTranscripts(forPodcast: "SwiftUI Weekly")

print("Found \(transcripts.count) transcripts")
for transcript in transcripts {
    print("- \(transcript.episodeTitle): \(transcript.fileSize) bytes")
    print("  Downloaded \(transcript.downloadCount) times")
}
```

### 3. Check Availability Before Showing Features

```swift
let service = CloudKitTranscriptService()
let availability = await service.checkAvailability()

switch availability {
case .available:
    showCloudKitFeatures()

case .unavailable(.noAccount):
    showMessage("Sign in to iCloud to use shared transcripts")

case .unavailable(.restricted):
    showMessage("iCloud access restricted")

case .unavailable(let reason):
    showMessage("CloudKit unavailable: \(reason)")
}
```

---

## Error Handling

### Graceful Degradation

CloudKit is **optional**. All errors result in fallback to local generation:

```swift
// CloudKit check fails â†’ Generate locally
// CloudKit download fails â†’ Generate locally
// CloudKit upload fails â†’ Local transcript still saved
```

### Common Scenarios

| Scenario | Behavior |
|----------|----------|
| No iCloud account | Show message, disable CloudKit, generate locally |
| Offline | Skip CloudKit check, generate locally |
| CloudKit unavailable | Disable CloudKit, generate locally |
| Upload fails | Complete job successfully (local saved) |
| Download fails | Fall back to local generation |

### Implementation

```swift
// In TranscriptManager.processJob():
if cloudKitEnabled, let episodeURL = job.audioURL {
    do {
        if let transcript = try await cloudKitService.findTranscript(forEpisodeURL: episodeURL) {
            // Download and return early
            return
        }
    } catch {
        logger.warning("CloudKit check failed, generating locally: \(error)")
        // Continue to local generation (no error thrown)
    }
}

// Local generation always happens if CloudKit fails
```

---

## Performance Metrics

### Typical Episode (30 minutes)

| Metric | CloudKit | Local Generation | Savings |
|--------|----------|------------------|---------|
| Time | ~3 seconds | ~2-5 minutes | **95%+** |
| Battery | <1% | ~5-10% | **90%+** |
| Network | ~500 KB download | ~1.6 GB model download (first time) | **99%+** |
| Processing | None | High (Neural Engine) | **100%** |

### Breakdown

**CloudKit Download:**
- Lookup: ~500ms
- Download: ~2-3 seconds (typical SRT ~500 KB)
- Save to disk: ~100ms
- **Total: ~3 seconds**

**Local Generation:**
- Model check: ~1 second
- Model download (first time): ~2-3 minutes
- Transcription: ~1-3 minutes (varies by length)
- SRT creation: ~10 seconds
- Save to disk: ~100ms
- CloudKit upload: ~2-3 seconds (background)
- **Total: 2-5 minutes**

---

## UI Integration Examples

### 1. Show CloudKit Status in Transcript Tab

```swift
if viewModel.transcriptState == .completed {
    HStack {
        if viewModel.transcriptSource == .cloudKitDownload {
            Label("Downloaded from shared cache", systemImage: "icloud.and.arrow.down")
                .font(.caption)
                .foregroundColor(.blue)
        } else {
            Label("Generated on device", systemImage: "iphone")
                .font(.caption)
                .foregroundColor(.green)
        }
    }
}
```

### 2. Statistics Card in Settings

```swift
struct CloudKitStatsCard: View {
    let stats: CloudKitTranscriptStats

    var body: some View {
        GroupBox {
            VStack(alignment: .leading, spacing: 12) {
                Text("CloudKit Statistics")
                    .font(.headline)

                HStack {
                    Label("\(stats.totalDownloaded)", systemImage: "arrow.down.circle")
                    Text("Downloads")
                    Spacer()
                    Label("\(stats.totalUploaded)", systemImage: "arrow.up.circle")
                    Text("Uploads")
                }

                Divider()

                HStack {
                    Image(systemName: "clock.fill")
                    Text("Time saved: \(stats.formattedTimeSaved)")
                        .font(.subheadline)
                        .foregroundColor(.secondary)
                }
            }
        }
    }
}
```

### 3. Enable/Disable Toggle in Settings

```swift
struct CloudKitSettingsView: View {
    @ObservedObject var transcriptManager = TranscriptManager.shared

    var body: some View {
        Form {
            Section {
                Toggle("Share Transcripts via iCloud", isOn: $transcriptManager.cloudKitEnabled)
                    .onChange(of: transcriptManager.cloudKitEnabled) { enabled in
                        transcriptManager.setCloudKitEnabled(enabled)
                    }

                Text("When enabled, transcripts are shared anonymously with other users to speed up generation.")
                    .font(.caption)
                    .foregroundColor(.secondary)
            } header: {
                Text("CloudKit Sync")
            }
        }
    }
}
```

---

## Privacy & Security

### What's Shared

âœ… **Public information only:**
- Episode title
- Podcast title
- Transcript content (SRT)
- Language
- Audio duration

âŒ **Never shared:**
- User identity
- Listening history
- Playback progress
- Personal data

### Anonymous Creator IDs

All uploads use creator ID = `"anonymous"` to protect user privacy.

### Public Database

Uses CloudKit **public database**:
- No personal data storage
- No user-to-user associations
- Content-only sharing
- Read/write access for everyone

---

## Troubleshooting

### "CloudKit Not Available"

**Check:**
1. iCloud account signed in (Settings â†’ [Your Name])
2. iCloud Drive enabled
3. Internet connection active
4. App has iCloud capability in Xcode

### "No Transcripts Found in CloudKit"

**Possible causes:**
- First user for this episode (generate locally)
- Different `audioURL` (slight variations)
- Episode too new (not uploaded yet)
- CloudKit sync delay (usually <1 minute)

### "Upload Failed"

**Non-critical:**
- Local transcript still saved
- Job completes successfully
- Will retry on next generation
- Check internet connection

### CloudKit Dashboard Shows No Records

**Verify:**
1. Container identifier matches: `iCloud.com.podcastanalyzer`
2. Using **public database** (not private)
3. Record type `SharedTranscript` exists
4. Indexes created on `episodeAudioURL` and `podcastTitle`
5. Permissions set to allow public read/write

---

## Best Practices

### 1. Always Provide `audioURL`

```swift
// âœ… Good - CloudKit enabled
TranscriptManager.shared.queueTranscript(
    ...,
    audioURL: episode.audioURL,
    ...
)

// âŒ Bad - CloudKit disabled
TranscriptManager.shared.queueTranscript(
    ...,
    audioURL: nil,  // CloudKit won't work!
    ...
)
```

### 2. Check Availability Before Showing Features

```swift
Task {
    let availability = await cloudKitService.checkAvailability()
    if availability.isAvailable {
        showCloudKitBadges = true
    }
}
```

### 3. Handle Errors Gracefully

```swift
// Don't show errors to users for CloudKit failures
// (they still get local generation)

// âœ… Log only
logger.warning("CloudKit upload failed: \(error)")

// âŒ Don't alert user
// showAlert("CloudKit Error: \(error)")
```

### 4. Update UI Based on Source

```swift
switch transcriptSource {
case .cloudKitDownload:
    showBadge("Shared from community", color: .blue)
case .localGeneration:
    showBadge("Generated on device", color: .green)
}
```

---

## Future Enhancements

### Potential Features

1. **Quality Ratings**
   - Users rate transcript accuracy
   - Show average rating in CloudKit
   - Prefer highly-rated transcripts

2. **Version Conflict Resolution**
   - Multiple users generate same episode
   - Keep highest quality (manual review?)
   - Merge if different timestamps

3. **Compression**
   - Compress large SRT files before upload
   - Reduce storage and bandwidth
   - Decompress on download

4. **Batch Prefetch**
   - Download all transcripts for podcast series
   - Background task
   - Ready when user needs them

5. **Download Count Leaderboard**
   - Show most popular episodes
   - Community contribution stats
   - Gamification for uploads

6. **Language Variants**
   - Support multiple languages per episode
   - User chooses preferred language
   - Translation integration

---

## Summary

CloudKit transcript sharing provides:

âœ… **Massive time savings** (95%+ when cached)
âœ… **Battery efficiency** (no local processing)
âœ… **Community benefit** (help other users)
âœ… **Privacy-first** (anonymous, public data only)
âœ… **Graceful fallback** (local generation always works)
âœ… **Zero infrastructure cost** (CloudKit handles everything)

**Simple to use:**
```swift
// 1. Enable
TranscriptManager.shared.setCloudKitEnabled(true)

// 2. Queue with audioURL
TranscriptManager.shared.queueTranscript(..., audioURL: episode.audioURL, ...)

// 3. Done! CloudKit handles the rest
```

Users get **instant transcripts** when available, and help build a **shared community cache** for everyone else. Win-win! ğŸ‰
